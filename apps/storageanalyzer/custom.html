<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>
    <script src="../../core/lib/customize.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>    

    <!-- Toggle Buttons -->
    <div class="btn-group" style="margin: 1em; display: flex; justify-content: center;">
      <button id="tableButton" class="btn btn-primary">View Table</button>
      <button id="pieChartButton" class="btn">View Pie Charts</button>
    </div>

    <!-- Table View -->
    <div id="storageTable"></div>

    <!-- Charts View -->
    <div id="storagePieCharts" style="display: none; flex-direction: column; align-items: center; gap: 1.5em;">
      <!-- App Breakdown Chart -->
      <div id="piechart" style="width: 100%; max-width: 600px; height: 400px;"></div>
      <!-- Total Storage Chart -->
      <div id="totalStoragePie" style="width: 100%; max-width: 600px; height: 300px;"></div>
    </div>

    <script>
      let globalApps = [];
      let storageStats = null;
      let hasGetStats = true;

      function onInit(device) {
        Util.showModal("Reading Storage...");

        // Fetch app list and stats from the watch
        Puck.eval(`(()=>{
          const Storage = require("Storage");
          const getApps = () => Storage.list(/\\.info$/).map(n => {
            const app = Storage.readJSON(n,1)||{};
            let fileSize=0, dataSize=0;
            if (app.files) app.files.split(",").forEach(f=>{
              const d = Storage.read(f); if (d) fileSize += d.length;
            });
            const parts = (app.data||"").split(";");
            function toRegExp(wc) { return new RegExp("^"+wc.replace(/[.+?^${}()|[\\]\\\\]/g,"\\\\$&").replace(/\\*/g,".*")+"$"); }
            if (parts[0]) parts[0].split(",").forEach(wc=>{
              Storage.list(toRegExp(wc), {sf:false}).forEach(f=>{const d=Storage.read(f); if (d) dataSize += d.length;});
            });
            if (parts[1]) parts[1].split(",").forEach(wc=>{
              Storage.list(toRegExp(wc), {sf:true}).forEach(f=>{ try{ dataSize += Storage.open(f,"r").getLength(); }catch(e){} });
            });
            return [app.id||"Unknown", fileSize, dataSize];
          });

          let stats;
          try { stats = Storage.getStats(); } catch(e) { stats = null; }
          return [getApps(), stats];
        })()`, function(result) {
          Util.hideModal();
          globalApps = result[0].sort((a,b)=>(b[1]+b[2])-(a[1]+a[2]));
          storageStats = result[1];
          hasGetStats = !!storageStats;

          if (globalApps.length === 0) {
            document.getElementById("storageTable").innerHTML = "<p>No apps found</p>";
            return;
          }

          drawTable();
        });
      }

      function drawTable() {
        document.getElementById("storageTable").innerHTML = `
          <table class="table table-striped">
            <thead>
              <tr>
                <th>App</th>
                <th>Code (KB)</th>
                <th>Data (KB)</th>
                <th>Total (KB)</th>
              </tr>
            </thead>
            <tbody>
              ${globalApps.map(app => `
                <tr>
                  <td>${app[0]}</td>
                  <td>${(app[1]/1000).toFixed(1)}</td>
                  <td>${(app[2]/1000).toFixed(1)}</td>
                  <td>${((app[1]+app[2])/1000).toFixed(1)}</td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      }

      function drawCharts() {
        if (globalApps.length === 0) return;

        // Chart 1: App Breakdown
        const appData = google.visualization.arrayToDataTable([
          ['App', 'Total Size (KB)'],
          ...globalApps.map(a => [a[0], (a[1]+a[2])/1000])
        ]);

        const appChart = new google.visualization.PieChart(document.getElementById('piechart'));
        appChart.draw(appData, {
          title: 'App Storage Breakdown',
          chartArea: { width: '90%', height: '80%' },
          legend: { position: 'bottom' }
        });

        // Chart 2: Total Storage (only if stats available, i.e., Bangle.js 2)
        const totalDiv = document.getElementById('totalStoragePie');
        if (!hasGetStats) {
          totalDiv.style.display = "none"; // hide for Bangle.js 1
          return;
        }

        const used = (storageStats.fileBytes||0)/1000;
        const free = (storageStats.freeBytes||0)/1000;
        const trash = (storageStats.garbageBytes||0)/1000;

        const totalData = google.visualization.arrayToDataTable([
          ['Type', 'KB'],
          ['Used', used],
          ['Free', free],
          ['Trash', trash]
        ]);

        const totalChart = new google.visualization.PieChart(totalDiv);
        totalChart.draw(totalData, {
          title: 'Total Storage Usage',
          pieHole: 0.4,
          chartArea: { width: '90%', height: '80%' },
          legend: { position: 'bottom' }
        });
      }

      // Load Google Charts
      google.charts.load('current', {'packages':['corechart']});

      document.getElementById("pieChartButton").addEventListener("click", function() {
        document.getElementById("storageTable").style.display = "none";
        document.getElementById("storagePieCharts").style.display = "flex";
        google.charts.setOnLoadCallback(drawCharts);
        this.classList.add("btn-primary");
        document.getElementById("tableButton").classList.remove("btn-primary");
      });

      document.getElementById("tableButton").addEventListener("click", function() {
        document.getElementById("storageTable").style.display = "block";
        document.getElementById("storagePieCharts").style.display = "none";
        drawTable();
        this.classList.add("btn-primary");
        document.getElementById("pieChartButton").classList.remove("btn-primary");
      });

      window.onInit = onInit;
    </script>
  </body>
</html>
