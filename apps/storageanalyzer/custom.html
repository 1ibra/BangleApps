<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>
    <script src="../../core/lib/customize.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>    

    <!-- Toggle Buttons -->
    <div class="btn-group" style="margin: 1em; display: flex; justify-content: center;">
      <button id="tableButton" class="btn btn-primary">View Table</button>
      <button id="pieChartButton" class="btn">View Pie Chart</button>
    </div>

    <!-- Table View -->
    <div id="storageTable"></div>

    <!-- Chart View -->
    <div id="storagePieChart" style="display: none; flex-direction: column; align-items: center;">
      <div id="piechart" style="width: 100%; max-width: 600px; height: 400px;"></div>
      <div id="totalStoragePie" style="width: 100%; max-width: 600px; height: 300px; margin-top: 2em;"></div>
    </div>

    <script>
      let globalApps = [];
      let storageStats = null;
      let isBangle2 = false;

      function onInit(device) {
        isBangle2 = device?.HWVERSION === 2;

        Util.showModal("Reading Storage...");

        const evalCode = `(()=>{
          const Storage = require("Storage");
          let apps = Storage.list(/\\.info$/).map(infoFile => {
            let info = Storage.readJSON(infoFile, 1) || {};
            let codeSize = 0, dataSize = 0;
            if (info.files && info.files.length) {
              info.files.split(",").forEach(f => {
                let fileData = Storage.read(f);
                if (fileData) codeSize += fileData.length;
              });
            }
            let data = (info.data||"").split(";");
            function wcToRegExp(wc) {
              return new RegExp("^"+wc.replaceAll(".", "\\\\.").replaceAll("?", ".*")+"$");
            }
            if (data[0]) data[0].split(",").forEach(wc => {
              Storage.list(wcToRegExp(wc), {sf:false}).forEach(f => {
                let d = Storage.read(f);
                if (d) dataSize += d.length;
              });
            });
            if (data[1]) data[1].split(",").forEach(wc => {
              Storage.list(wcToRegExp(wc), {sf:true}).forEach(f => {
                let openFile = Storage.open(f, "r");
                if (openFile) dataSize += openFile.getLength();
              });
            });
            return [info.id || infoFile.replace(".info",""), codeSize, dataSize];
          });
          ${
            isBangle2 
              ? "let stats = Storage.getStats(); return [apps, stats];"
              : "return [apps, null];"
          }
        })()`;

        Puck.eval(evalCode, function(result) {
          Util.hideModal();

          globalApps = result[0].sort((a,b) => (b[1]+b[2]) - (a[1]+a[2]));
          storageStats = result[1];

          if (!isBangle2) {
            // Hide total storage pie for Bangle.js 1
            document.getElementById('totalStoragePie').style.display = 'none';
          } else {
            document.getElementById('totalStoragePie').style.display = 'block';
          }

          if (globalApps.length === 0) {
            document.getElementById("storageTable").innerHTML = "<p>No apps found</p>";
            return;
          }

          drawTable();
        });
      }

      function drawTable() {
        document.getElementById("storageTable").innerHTML = `
          <table class="table table-striped">
            <thead>
              <tr>
                <th>App</th>
                <th>Code (KB)</th>
                <th>Data (KB)</th>
                <th>Total (KB)</th>
              </tr>
            </thead>
            <tbody>
              ${globalApps.map(app => `
                <tr>
                  <td>${app[0]}</td>
                  <td>${(app[1]/1000).toFixed(1)}</td>
                  <td>${(app[2]/1000).toFixed(1)}</td>
                  <td>${((app[1]+app[2])/1000).toFixed(1)}</td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      }

      function drawChart() {
        if (globalApps.length === 0) return;

        // Draw pie chart for apps
        const appChartData = [
          ['App', 'Total Size (KB)']
        ].concat(globalApps.map(app => [app[0], (app[1] + app[2])/1000]));

        const dataApps = google.visualization.arrayToDataTable(appChartData);
        const appChartOptions = {
          title: 'App Storage Breakdown',
          chartArea: { width: '90%', height: '80%' },
          legend: { position: 'bottom' }
        };

        const appChart = new google.visualization.PieChart(document.getElementById('piechart'));
        appChart.draw(dataApps, appChartOptions);

        // Draw total storage pie only on Bangle.js 2
        if (isBangle2 && storageStats) {
          const usedKB = storageStats.usedBytes / 1000;
          const freeKB = storageStats.freeBytes / 1000;

          const totalChartData = google.visualization.arrayToDataTable([
            ['Type', 'KB'],
            ['Used', usedKB],
            ['Free', freeKB]
          ]);

          const totalChartOptions = {
            title: 'Total Storage Usage',
            pieHole: 0.4,
            chartArea: { width: '90%', height: '80%' },
            legend: { position: 'bottom' }
          };

          const totalChart = new google.visualization.PieChart(document.getElementById('totalStoragePie'));
          totalChart.draw(totalChartData, totalChartOptions);
        }
      }

      // Load Google Charts
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(() => {
        drawTable(); // Start with table view
      });

      // Buttons event listeners
      document.getElementById("pieChartButton").addEventListener("click", () => {
        document.getElementById("storageTable").style.display = "none";
        document.getElementById("storagePieChart").style.display = "flex";
        drawChart();

        document.getElementById("pieChartButton").classList.add("btn-primary");
        document.getElementById("tableButton").classList.remove("btn-primary");
      });

      document.getElementById("tableButton").addEventListener("click", () => {
        document.getElementById("storageTable").style.display = "block";
        document.getElementById("storagePieChart").style.display = "none";
        drawTable();

        document.getElementById("tableButton").classList.add("btn-primary");
        document.getElementById("pieChartButton").classList.remove("btn-primary");
      });

      // Register entrypoint for app loader
      window.onInit = onInit;
    </script>
  </body>
</html>
