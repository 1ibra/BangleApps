<html>

<head>
  <link rel="stylesheet" href="../../css/spectre.min.css">
  <script src="https://cdn.jsdelivr.net/gh/mourner/simplify-js@1.2.4/simplify.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>

<body>
  <p id="status">No course</p>
  <div>
    <button id="upload" class="btn btn-primary" disabled="true">Upload to Device</button>
    <button id="download" class="btn btn-primary" disabled="true">Download Course</button>
  </div>

  <script src="../../core/lib/customize.js"></script>
  <script src="./maptools.js"></script>

  <script>
    const url = "https://overpass-api.de/api/interpreter";
    let query = `[bbox:38.4829,-121.8694,38.7110,-121.6215][out:json][timeout:5];way["name"="Davis Golf Course"];map_to_area ->.golfcourse;way["golf"="hole"](area.golfcourse)->.holes;(relation["golf"="fairway"](area.golfcourse);way["golf"~"^(green|tee|water_hazard|bunker|fairway)"](area.golfcourse);)->.features;.holes out geom;.features out geom;`;
    let course_input = null;

    function findNodeCoordinates(elements, id) {
      for (let i = 0; i < elements.length; i++) {
        if (elements[i].type === "node" && elements[i].id === id) {
          let thing = (({ lat, lon }) => ({ lat, lon }))(elements[i]);
          return thing;
        }
      }
      console.error("node id: ", id, " not found");
    }

    function processFeatures(course_verbose) {
      let course_processed = {
        holes: {}
      };
      for (let i = 0; i < course_verbose.length; i++) {
        const element = course_verbose[i];

        if (element.tags.golf === "hole") {
          // if we find a high-level hole feature
          // todo check if hole exists
          let current_hole = parseInt(element.tags.ref); //subsequent way features should be applied to the current hole
          let tees = []
          Object.keys(element.tags).forEach((key) => {
            if (key.includes("dist")) {
              tees.push(Math.round(element.tags[key]));
            }
          })
          var hole = {
            hole_number: current_hole,
            handicap: parseInt(element.tags.handicap),
            par: parseInt(element.tags.par),
            nodesXY: preprocessCoords(element.geometry, element.geometry[0]),
            tees: tees.sort(),
            way: element.geometry,
            features: [],
            angle: 0,
          }

          hole.angle = angle(hole.nodesXY[0], hole.nodesXY[hole.nodesXY.length - 1])
          course_processed.holes[current_hole.toString()] = hole;
        }

        else {
          if (!("ref" in element.tags)) continue;
          if (element.type == "relation") {
            for (member of element.members) {
              if (member.role === "outer") break; // only use the outer because it is overwritten anyway
            }
            Object.assign(element, { "geometry": member.geometry });
          }
          // if we find a feature add it to the corresponding hole
          let active_holes = element.tags.ref.split(";"); // a feature can be on more than one hole
          for (feature_hole of active_holes) {
            let new_feature = {
              nodes: preprocessCoords(element.geometry, course_processed.holes[feature_hole].way[0]),
              type: element.tags.golf,
              id: element.id,
            }
            course_processed.holes[feature_hole].features.push(new_feature);
          }
        }
      }

      return course_processed;
    }

    function preprocessCoords(coord_array, origin) {
      let many_points = arraytoXY(coord_array, origin);
      let less_points = simplify(many_points, 2, true); // from simplify-js

      // convert to int to save some memory
      less_points = less_points.map(function (pt) {
        return { x: Math.round(pt.x), y: Math.round(pt.y) }
      });

      return less_points;
    }

    var courses = [];
    var course_name = "Davis";
    $("#upload").click(function () {
      sendCustomizedApp({
        storage: courses
      });
    });

    $("#download").click(function () {
      downloadObjectAsJSON(course, "golfcourse-" + course_name);
    });

    // download info from the course
    $.post(url, query, function (result) {
      course_input = result;
      console.log(course_input);
      out = processFeatures(course_input.elements);
      console.log(out);
      courses.push({
        name: "golfcourse-" + course_name + ".json",
        content: JSON.parse(JSON.stringify(out)) // deep copy
      });
      $('#status').text("Course retrieved!");
      $('#upload').attr("disabled", false);
      $('#download').attr("disabled", false);
    })

  </script>
</body>

</html>