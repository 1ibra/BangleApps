Graphics.prototype.setFontPaytoneOne = function(scale) {
  // Actual height 71 (81 - 11)
  this.setFontCustom(
    atob('AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPgAAAAAAAAAAAAAAD/wAAAAAAAAAAAAAA//gAAAAAAAAAAAAAH//AAAAAAAAAAAAAAf/+AAAAAAAAAAAAAD//8AAAAAAAAAAAAAf//wAAAAAAAAAAAAB///gAAAAAAAAAAAAH//+AAAAAAAAAAAAAf//4AAAAAAAAAAAAD///gAAAAAAAAAAAAP//+AAAAAAAAAAAAA///4AAAAAAAAAAAAD///gAAAAAAAAAAAAH//+AAAAAAAAAAAAAf//4AAAAAAAAAAAAB///gAAAAAAAAAAAAD//8AAAAAAAAAAAAAP//wAAAAAAAAAAAAAf/+AAAAAAAAAAAAAA//wAAAAAAAAAAAAAB/+AAAAAAAAAAAAAAB/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAAAAAAAAAAAAAfAAAAAAAAAAAAAAAH8AAAAAAAAAAAAAAD/wAAAAAAAAAAAAAA//AAAAAAAAAAAAAAf/8AAAAAAAAAAAAAP//wAAAAAAAAAAAAD///AAAAAAAAAAAAB///8AAAAAAAAAAAAf///wAAAAAAAAAAAP////AAAAAAAAAAAD////8AAAAAAAAAAB/////wAAAAAAAAAA//////AAAAAAAAAAP/////8AAAAAAAAAH//////wAAAAAAAAB///////AAAAAAAAA///////8AAAAAAAAf///////wAAAAAAAH////////AAAAAAAD////////wAAAAAAA////////4AAAAAAAf///////+AAAAAAAP////////AAAAAAAD////////gAAAAAAB////////4AAAAAAAf///////8AAAAAAAB////////AAAAAAAAH///////gAAAAAAAAf//////wAAAAAAAAB//////8AAAAAAAAAH/////+AAAAAAAAAAf/////gAAAAAAAAAB/////wAAAAAAAAAAH////4AAAAAAAAAAAf///+AAAAAAAAAAAB////AAAAAAAAAAAAH///wAAAAAAAAAAAAf//4AAAAAAAAAAAAB//8AAAAAAAAAAAAAH//AAAAAAAAAAAAAAf/gAAAAAAAAAAAAAB/4AAAAAAAAAAAAAAH8AAAAAAAAAAAAAAAfAAAAAAAAAAAAAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//AAAAAAAAAAAAAB///4AAAAAAAAAAAA////8AAAAAAAAAAAP////+AAAAAAAAAAD/////+AAAAAAAAAA//////8AAAAAAAAAP//////8AAAAAAAAB///////4AAAAAAAAP///////4AAAAAAAB////////wAAAAAAAP////////gAAAAAAB/////////AAAAAAAP////////+AAAAAAB/////////4AAAAAAP/////////wAAAAAA//////////gAAAAAH/////////+AAAAAA//////////8AAAAAD//////////wAAAAAP//////////gAAAAB//////////+AAAAAH////gB////8AAAAA////gAAf///wAAAAD///wAAAP///AAAAAP//8AAAAP//8AAAAA///gAAAAf//4AAAAD//8AAAAA///gAAAAf//gAAAAB//+AAAAB//+AAAAAH//4AAAAH//4AAAAAP//gAAAAf//AAAAAA//+AAAAB//8AAAAAD//4AAAAH//wAAAAAP//gAAAAf//AAAAAA//+AAAAB//+AAAAAD//4AAAAH//4AAAAAf//gAAAAf//wAAAAD//+AAAAA///gAAAAf//4AAAAD///AAAAD///gAAAAP///AAAA///8AAAAA////AAAP///wAAAAB////gAH////AAAAAH//////////4AAAAAf//////////gAAAAA//////////+AAAAAD//////////wAAAAAH//////////AAAAAAf/////////4AAAAAA//////////AAAAAAB/////////8AAAAAAD/////////gAAAAAAP////////8AAAAAAAf////////gAAAAAAA////////8AAAAAAAB////////gAAAAAAAB///////8AAAAAAAAD///////gAAAAAAAAH//////4AAAAAAAAAH/////+AAAAAAAAAAH/////gAAAAAAAAAAH////4AAAAAAAAAAAD///8AAAAAAAAAAAAA//8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/4AAAAB//wAAAAAB//gAAAAH//AAAAAAH/+AAAAAf/8AAAAAAf/4AAAAB//wAAAAAB//AAAAAH//AAAAAAH/8AAAAAf/8AAAAAAf/wAAAAB//wAAAAAD//AAAAAH//AAAAAAP/////////8AAAAAA//////////wAAAAAH//////////AAAAAAf/////////8AAAAAB//////////wAAAAAP//////////AAAAAA//////////8AAAAAH//////////wAAAAAf//////////AAAAAD//////////8AAAAAP//////////wAAAAB///////////AAAAAH//////////8AAAAAf//////////wAAAAB///////////AAAAAH//////////8AAAAAf//////////wAAAAB///////////AAAAAH//////////8AAAAAf//////////wAAAAB///////////AAAAAH//////////8AAAAAAAAAAAAAB//wAAAAAAAAAAAAAH//AAAAAAAAAAAAAAf/8AAAAAAAAAAAAAB//wAAAAAAAAAAAAAH//AAAAAAAAAAAAAAf/8AAAAAAAAAAAAAB//wAAAAAAAAAAAAAH//AAAAAAAAAAAAAAf/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeAAAAAAAAAAAAAAAD/AAAAAAB//wAAAAAP/gAAAAAP//AAAAAA//wAAAAB//8AAAAAH//4AAAAP//wAAAAAf//AAAAB///AAAAAD//8AAAAP//8AAAAAP//gAAAB///wAAAAA//+AAAAP///AAAAAH//wAAAB///8AAAAAf//AAAAP///wAAAAB//8AAAB////AAAAAH//wAAAP///8AAAAA//+AAAB////wAAAAD//4AAAP////AAAAAP//gAAB////8AAAAA//+AAAP////wAAAAD//4AAB/////AAAAAP//gAAP////8AAAAA//+AAD/////wAAAAD//4AAf/////AAAAAP//wAH/////8AAAAA///gA///9//wAAAAD///Af///3//AAAAAP///////+f/8AAAAA////////x//wAAAAD////////H//AAAAAP///////4f/8AAAAAf///////B//wAAAAB///////4H//AAAAAH///////gf/8AAAAAf//////8B//wAAAAA///////gH//AAAAAD//////8Af/8AAAAAH//////gB//wAAAAAf/////8AH//AAAAAA//////gAf/8AAAAAB/////8AB//wAAAAAD/////gAH//AAAAAAH////8AAf/8AAAAAAP////AAB//wAAAAAAf///wAAH//AAAAAAAf//+AAAf/8AAAAAAAf//AAAB//wAAAAAAAP/AAAAH//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAAAAAAAAAAAAB+AAAAAAAAPAAAAAAP/gAAAAAAf8AAAAAA//wAAAAAf/wAAAAAH//gAAAAP//gAAAAAf/+AAAAAf/+AAAAAB//wAAAAB//4AAAAAP//AAAAAH//gAAAAA//8AAAAAP//AAAAAD//gB//AA//8AAAAAf/+AH/8AD//wAAAAB//4Af/wAP//AAAAAH//gB//AAf/+AAAAAf/8AH/8AB//4AAAAD//wAf/wAH//gAAAAP//AD//AAf/+AAAAA//8AP/8AB//4AAAAD//wA//wAH//gAAAAP//AD//AAf/+AAAAA//8AP/+AB//4AAAAD//wA//4AH//gAAAAP//AH//gAf/+AAAAA//8Af/+AB//4AAAAD//wD//8AH//gAAAAP//gP//wA//+AAAAA///B///gH//4AAAAD///f///g///gAAAAP//////////+AAAAA///////////4AAAAD///////////AAAAAH//////////8AAAAAf//////////wAAAAB///////////AAAAAD//////////4AAAAAP//////////gAAAAA////+/////8AAAAAB////5/////wAAAAAD////H////+AAAAAAP///4P////4AAAAAAf///A/////AAAAAAA///4B////4AAAAAAA//+AD////AAAAAAAB//wAH///4AAAAAAAA/4AAP///AAAAAAAAAAAAAP//4AAAAAAAAAAAAAP/+AAAAAAAAAAAAAAP/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/8AAAAAAAAAAAAAH//wAAAAAAAAAAAAA///AAAAAAAAAAAAAP//8AAAAAAAAAAAAB///wAAAAAAAAAAAAP///AAAAAAAAAAAAD///8AAAAAAAAAAAAf///wAAAAAAAAAAAD////AAAAAAAAAAAA////8AAAAAAAAAAAH////wAAAAAAAAAAB/////AAAAAAAAAAAP////8AAAAAAAAAAB/////wAAAAAAAAAAf/////AAAAAAAAAAD///v/8AAAAAAAAAA///4//wAAAAAAAAAH///D//AAAAAAAAAA///wP/8AAAAAAAAAP//+A//wAAAAAAAAB///gD//AAAAAAAAAf//8AP/8AAAAAAAAD///AA//wAAAAAAAAf//4AD//AAAAAAAAH//+AAP/8AAAAAAAA///wAA//wAAAAAAAH//8AAD//AAAAAAAAf//////////wAAAAB///////////gAAAAH//////////+AAAAAf//////////4AAAAB///////////gAAAAH//////////+AAAAAf//////////4AAAAB///////////gAAAAH//////////+AAAAAf//////////4AAAAB///////////gAAAAH//////////+AAAAAf//////////4AAAAB///////////gAAAAH//////////+AAAAAf//////////4AAAAB///////////gAAAAH//////////+AAAAAf//////////4AAAAB///////////gAAAAH//////////+AAAAAf//////////4AAAAAAAAAAA//wAAAAAAAAAAAAAD//AAAAAAAAAAAAAAP/8AAAAAAAAAAAAAA//wAAAAAAAAAAAAAD//AAAAAAAAAAAAAAP/8AAAAAAAAAAAAAA//wAAAAAAAAAAAAAD//AAAAAAAAAAAAAAP/8AAAAAAAAAAAAAA//wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH8AAAAAAAAAAAAB///wAB/+AAAAAAf/////gA//8AAAAAP/////+AB//wAAAAA//////8AH//AAAAAD//////wAf/+AAAAAP//////AA//4AAAAA//////+AD//gAAAAD//////4AP//AAAAAP//////wA//8AAAAA///////AB//wAAAAD//////8AH//AAAAAP//////gAf/+AAAAA//////+AB//4AAAAD//////wAH//gAAAAP//////AAf/+AAAAA//8Af/4AB//4AAAAD//gD//gAH//gAAAAP/+AP/+AAf/+AAAAA//4A//wAB//4AAAAD//gH//AAH//gAAAAP/+Af/8AAf/+AAAAA//4B//4AD//4AAAAD//gH//gAP//gAAAAP/+Af//AB//+AAAAA//4B//+AP//4AAAAD//gH//+D///gAAAAP/+Af//////8AAAAA//4B///////wAAAAD//gH///////AAAAAP/+Af//////8AAAAA//4B///////gAAAAD//gD//////+AAAAAP/+AP//////wAAAAA//4A///////AAAAAD//gB//////4AAAAAP/+AH//////gAAAAA//4AP/////8AAAAAD//gAf/////gAAAAAP/+AA/////8AAAAAA//gAD/////gAAAAABgAAAD////8AAAAAAAAAAAH////gAAAAAAAAAAAP///8AAAAAAAAAAAAP///AAAAAAAAAAAAAP//wAAAAAAAAAAAAAD/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/AAAAAAAAAAAAAB///4AAAAAAAAAAAA////+AAAAAAAAAAAf////+AAAAAAAAAAH/////+AAAAAAAAAB//////+AAAAAAAAAP//////8AAAAAAAAD///////4AAAAAAAAf///////wAAAAAAAD////////gAAAAAAAf////////AAAAAAAD////////+AAAAAAAf////////8AAAAAAD/////////4AAAAAAf/////////gAAAAAB//////////AAAAAAP/////////8AAAAAB//////////4AAAAAH//////////gAAAAA//////////+AAAAAD//////////8AAAAAP///4f+D///wAAAAB///8D/wB///AAAAAH///AP/AB//+AAAAAf//wB/8AD//4AAAAD//+AP/wAH//gAAAAP//wA/+AAP/+AAAAA//+AH/4AA//4AAAAD//4Af/gAD//gAAAAP//gB/+AAP/+AAAAA//8AP/4AA//4AAAAD//wA//wAD//gAAAAP//AD//AAP/+AAAAA//8AP/8AA//4AAAAD//wA//4AH//gAAAAP//AD//gA//+AAAAA//8AP//AH//4AAAAD//wA///B///AAAAAP//AD//////8AAAAAf/8AP//////wAAAAB//4A///////AAAAAH//gD//////4AAAAAf/+AP//////gAAAAA//8Af/////8AAAAAD//wB//////wAAAAAP//AH/////+AAAAAAf/+AP/////wAAAAAB//4Af/////AAAAAAD//wB/////4AAAAAAP/+AD/////AAAAAAAf/AAH////4AAAAAAB/gAAP////AAAAAAADwAAAf///4AAAAAAAAAAAA////AAAAAAAAAAAAA///wAAAAAAAAAAAAA//8AAAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH/+AAAAAAAAAAAAAA//4AAAAAAAAAAAAAD//gAAAAAAAAAAAAAP/+AAAAAAAcAAAAAA//4AAAAAAH4AAAAAD//gAAAAAD/gAAAAAP/+AAAAAA/+AAAAAA//4AAAAAP/8AAAAAD//gAAAAH//wAAAAAP/+AAAAB///gAAAAA//4AAAA///+AAAAAD//gAAAP///4AAAAAP/+AAAH////wAAAAA//4AAB/////AAAAAD//gAAf////+AAAAAP/+AAP/////4AAAAA//4AD//////wAAAAD//gB///////AAAAAP/+Af//////8AAAAA//4P///////4AAAAD//j////////gAAAAP/+////////+AAAAA///////////gAAAAD//////////wAAAAAP/////////8AAAAAA//////////AAAAAAD/////////gAAAAAAP////////4AAAAAAA////////8AAAAAAAD////////AAAAAAAAP///////gAAAAAAAA///////4AAAAAAAAD//////8AAAAAAAAAP//////AAAAAAAAAA//////gAAAAAAAAAD/////4AAAAAAAAAAP////8AAAAAAAAAAA/////AAAAAAAAAAAD////gAAAAAAAAAAAP///4AAAAAAAAAAAA///+AAAAAAAAAAAAD///AAAAAAAAAAAAAP//wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/4AAAAAAAAAAAAAA//4AAAAAAAAAAAAAH//4AAAAAAAAAAAAB///wAAAAAAAAAAAAP///gAAAAAAAB/8AB////AAAAAAAAf/+AH///+AAAAAAAH//8A////8AAAAAAA///8H////wAAAAAAH///4f////gAAAAAA////z/////AAAAAAH////v////8AAAAAA//////////wAAAAAD//////////gAAAAAf/////////+AAAAAB//////////8AAAAAP//////////wAAAAA///////////AAAAAH//////////8AAAAAf//////////wAAAAB///////g///gAAAAH/8P///4A//+AAAAA//gP//+AB//4AAAAD/8Af//wAD//gAAAAP/wB///AAP/+AAAAA/+AD//+AAf/4AAAAD/4AP//4AB//gAAAAP/gAf//wAH/+AAAAA/+AB///AAf/4AAAAD/4AD//8AB//gAAAAP/gAP//4AH/+AAAAA//AA///gAf/4AAAAD/8AB///AD//gAAAAP/4AP//+AP/+AAAAA//wD///4A//4AAAAD//5////wH//gAAAAP///////x//+AAAAAf//////////wAAAAB///////////AAAAAH//////////8AAAAAP//////////wAAAAA//////////+AAAAAD//////////4AAAAAH//////////gAAAAAP///3/////8AAAAAA////P/////wAAAAAB///4/////+AAAAAAD///B/////4AAAAAAH//4D/////AAAAAAAP//AH////4AAAAAAAP/wAP////AAAAAAAAHwAA////8AAAAAAAAAAAA////AAAAAAAAAAAAB///4AAAAAAAAAAAAD///AAAAAAAAAAAAAB//gAAAAAAAAAAAAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/gAAAAAAAAAAAAAP//wAAAAAAAAAAAAD///wAAAAAAAAAAAAf///gAAAeAAAAAAAH////gAAP8AAAAAAA/////AAH/wAAAAAAH////+AB//gAAAAAA/////8Af/+AAAAAAH/////wA//8AAAAAAf/////gD//wAAAAAD/////+AH//gAAAAAf/////8Af/+AAAAAB//////wB//4AAAAAP//////AD//wAAAAA//////+AP//AAAAAD//////4A//8AAAAAf//////gB//wAAAAB//////+AH//gAAAAH//8H//4Af/+AAAAA///AH//gB//4AAAAD//4AP/+AH//gAAAAP//AAf/4Af/+AAAAA//4AB//gB//4AAAAD//gAD/+AH//gAAAAP/+AAP/4Af/+AAAAA//4AA//gB//4AAAAD//gAD/8AP//gAAAAP/+AAP/wA//+AAAAA//4AA//AD//4AAAAD//gAD/4Af//gAAAAP//AAP/gD//+AAAAA//+AA/8Af//wAAAAD//8AH/wD///AAAAAH//8Af+A///8AAAAAf//+B/wf///gAAAAB//////////+AAAAAH//////////4AAAAAP//////////AAAAAA//////////8AAAAAB//////////gAAAAAH/////////8AAAAAAP/////////wAAAAAA/////////+AAAAAAB/////////wAAAAAAD////////+AAAAAAAH////////wAAAAAAAP///////+AAAAAAAA////////wAAAAAAAA///////+AAAAAAAAB///////gAAAAAAAAD//////8AAAAAAAAAD//////AAAAAAAAAAD/////wAAAAAAAAAAD////4AAAAAAAAAAAB///8AAAAAAAAAAAAAP/4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8AAAAeAAAAAAAAAAf+AAAP/AAAAAAAAAH/8AAB//AAAAAAAAA//4AAP/+AAAAAAAAH//wAB//8AAAAAAAAf//gAP//wAAAAAAAD//+AA///gAAAAAAAP//8AH//+AAAAAAAA///wAf//4AAAAAAAH///AB///gAAAAAAAf//8AH///AAAAAAAB///wAf//8AAAAAAAH///AB///wAAAAAAAf//8AH///AAAAAAAA///wAf//4AAAAAAAD///AB///gAAAAAAAP//4AD//+AAAAAAAAf//gAP//4AAAAAAAB//+AAf//AAAAAAAAD//wAB//4AAAAAAAAH/+AAD//AAAAAAAAAP/wAAD/4AAAAAAAAAP8AAAH+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=='),
    46,
    atob("HTBFLTQ0PzU/Lz8+HQ=="),
    100+(scale<<8)+(1<<16)
  );
  return this;
};

{ // must be inside our own scope here so that when we are unloaded everything disappears
  // we also define functions using 'let fn = function() {..}' for the same reason. function decls are global

let settings = Object.assign(
  require("Storage").readJSON("slopeclockpp.default.json", true) || {},
  require("Storage").readJSON("slopeclockpp.json", true) || {}
);

let drawTimeout;

let g2 = Graphics.createArrayBuffer(g.getWidth(),90,1,{msb:true});
let g2img = {
  width:g2.getWidth(), height:g2.getHeight(), bpp:1,
  buffer:g2.buffer, transparent:0
};
const slope = 20;
const offsy = 20; // offset of numbers from middle
const fontBorder = 4; // offset from left/right
const slopeBorder = 10, slopeBorderUpper = 4; // fudge-factor to move minutes down from slope
let R,x,y; // middle of the clock face
let dateStr = "";
let bgColors = [];
if (g.theme.dark) {
   if (settings.colorYellow) bgColors.push("#ff0");
   if (settings.colorCyan) bgColors.push("#0ff");
   if (settings.colorMagenta) bgColors.push("#f0f");
   if (settings.colorWhite) bgColors.push("#fff");
} else {
   if (settings.colorRed) bgColors.push("#f00");
   if (settings.colorGreen) bgColors.push("#0f0");
   if (settings.colorBlue) bgColors.push("#00f");
   if (settings.colorBlack) bgColors.push("#000");
}
let bgColor = bgColors[(Math.random()*bgColors.length)|0]||"#000";


// Draw the hour, and the minute into an offscreen buffer
let draw = function() {
  // queue next draw
  if (drawTimeout) clearTimeout(drawTimeout);
  drawTimeout = setTimeout(function() {
    drawTimeout = undefined;
    animate(false, function() {
      draw();
    });
  }, 60000 - (Date.now() % 60000));
  // Now draw this one
  R = Bangle.appRect;
  x = R.w / 2;
  y = R.y + R.h / 2 - 12; // 12 = room for date
  var date = new Date();
  var local_time = require("locale").time(date, 1);
  var hourStr = local_time.split(":")[0].trim().padStart(2,'0');
  var minStr = local_time.split(":")[1].trim().padStart(2, '0');
  dateStr = require("locale").dow(date, 1).toUpperCase()+ " "+
            require("locale").date(date, 0).toUpperCase();

  // Draw hour
  g.reset().clearRect(R); // clear whole background (w/o widgets)
  g.setFontAlign(-1, 0).setFont("PaytoneOne");
  g.drawString(hourStr, fontBorder, y-offsy).setFont("4x6"); // draw and unload custom font
  // add slope in background color
  g.setColor(g.theme.bg).fillPoly([0,y+slope-slopeBorderUpper, R.w,y-slope-slopeBorderUpper,
                                   R.w,y-slope, 0,y+slope]);
  // Draw minute to offscreen buffer
  g2.setColor(0).fillRect(0,0,g2.getWidth(),g2.getHeight()).setFontAlign(1, 0).setFont("PaytoneOne");
  g2.setColor(1).drawString(minStr, g2.getWidth()-fontBorder, g2.getHeight()/2).setFont("4x6"); // draw and unload custom font
  g2.setColor(0).fillPoly([0,0, g2.getWidth(),0, 0,slope*2]);
  // start the animation *in*
  animate(true);
};

let isAnimIn = true;
let animInterval;
// Draw *just* the minute image
let drawMinute = function() {
  var yo = slopeBorder + offsy + y - 2*slope*minuteX/R.w;
  // draw over the slanty bit
  g.setColor(bgColor).fillPoly([0,y+slope, R.w,y-slope, R.w,R.h+R.y, 0,R.h+R.y]);
  // draw the minutes
  g.setColor(g.theme.bg).drawImage(g2img, x+minuteX-(g2.getWidth()/2), yo-(g2.getHeight()/2));
};
let animate = function(isIn, callback) {
  if (animInterval) clearInterval(animInterval);
  isAnimIn = isIn;
  minuteX = isAnimIn ? -g2.getWidth() : 0;
  drawMinute();
  animInterval = setInterval(function() {
    minuteX += 8;
    let stop = false;
    if (isAnimIn && minuteX>=0) {
      minuteX=0;
      stop = true;
    } else if (!isAnimIn && minuteX>=R.w)
      stop = true;
    drawMinute();
    if (stop) {
      clearInterval(animInterval);
      animInterval=undefined;
      if (isAnimIn) {
        // draw the date
        g.setColor(g.theme.bg).setFontAlign(0, 0).setFont("6x15").drawString(dateStr, R.x + R.w/2, R.y+R.h-9);
        // draw the menu items
        clockInfoMenu.redraw();
        clockInfoMenu2.redraw();
      }
      if (callback) callback();
    }
  }, 20);
};

// clock info menus (scroll up/down for info)
let clockInfoDraw = (itm, info, options) => {
  let texty = options.y+41;
  // set a cliprect to stop us drawing outside our box
  g.reset().setClipRect(options.x, options.y, options.x+options.w-1, options.y+options.h-1);
  g.setFont("6x15").setBgColor(options.bg).setColor(options.fg).clearRect(options.x, texty-15, options.x+options.w-2, texty);

  if (options.focus) g.setColor(options.hl);
  if (options.x < g.getWidth()/2) { // left align
    let x = options.x+2;
    if (info.img) g.clearRect(x, options.y, x+23, options.y+23).drawImage(info.img, x, options.y);
    g.setFontAlign(-1,1).drawString(info.text, x,texty);
  } else { // right align
    let x = options.x+options.w-3;
    if (info.img) g.clearRect(x-23, options.y, x, options.y+23).drawImage(info.img, x-23, options.y);
    g.setFontAlign(1,1).drawString(info.text, x,texty);
  }
  // return ClipRect
  g.setClipRect(0,0,g.getWidth()-1, g.getHeight()-1);
};
let clockInfoItems = require("clock_info").load();
let clockInfoMenu = require("clock_info").addInteractive(clockInfoItems, { x:126, y:24, w:50, h:40, draw : clockInfoDraw, bg : g.theme.bg, fg : g.theme.fg, hl : "#f00"/*red*/ });
let clockInfoMenu2 = require("clock_info").addInteractive(clockInfoItems, { x:0, y:115, w:50, h:40, draw : clockInfoDraw, bg : bgColor, fg : g.theme.bg, hl : (bgColor=="#000")?"#f00"/*red*/:g.theme.fg });

// Show launcher when middle button pressed
Bangle.setUI({
  mode : "clock",
  remove : function() {
    // Called to unload all of the clock app
    if (animInterval) clearInterval(animInterval);
    animInterval = undefined;
    if (drawTimeout) clearTimeout(drawTimeout);
    drawTimeout = undefined;
    delete Graphics.prototype.setFontPaytoneOne;
    // remove info menu
    clockInfoMenu.remove();
    delete clockInfoMenu;
    clockInfoMenu2.remove();
    delete clockInfoMenu2;
  }
});
// Load widgets
Bangle.loadWidgets();
draw();
setTimeout(Bangle.drawWidgets,0);
}
