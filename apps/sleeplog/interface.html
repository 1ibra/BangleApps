<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>
    
    <div id="table"></div>

    <script src="../../core/lib/interface.js"></script>
    <script>
var domTable = document.getElementById("table");

function saveFile(logData, title) {
  var fileFormat = domTable.getElementById("fileFormat").selectedIndex;

  if (fileFormat === 1) {
    Util.saveCSV(
      title + ".txt",
      logData.map(entry => {
        return new Date(entry[0] *= 6E5).toLocaleString(undefined) + " > " +
          "unknown    ,non consec.,consecutive".split(",")[entry[2]] + " " +
          "unknown,not worn,awake,light sleep,deep sleep".split(",")[entry[1]];
      }).join("\n")
    );
  } else {
    var timeFormat = domTable.getElementById("timeFormat").selectedIndex;
    Util.saveCSV(
      title + ".csv",
      "time,sleep,consecutive\n" +
      logData.forEach(entry => {
        entry[0] *= 6E5;
        if (timeFormat === 1) entry[0] /= 1E3;
        if (timeFormat === 2) entry[0] = entry[0] / 864E5 + 25569;
        return entry.join(",");
      }).join("\n")
    );
  }
}

function readLog(date, callback) {
  Util.showModal("Downloading logged data...");
  Puck.eval(`require("sleeplog").readLog(date, date + 12096E5)`, logData => {
    Util.hideModal();
    callback(logData);
  });
}
function getFnList() {
  Util.showModal("Loading...");
  domTable.innerHTML = "";
  Puck.eval(`require("Storage").list(/^sleeplog_\\d\\d\\d\\d\\.log$/)`, files => {
    // add this fortnight
    files.push("" + Math.floor(Date.now() / 12096E5 - 0.25));
    files = files.map(file => {
      var ret = {
        bName: file,
        date: (parseInt(file.substr(9, 4)) + 0.25) * 12096E5,
      }
      console.log(ret.date);
      var thisDates = [new Date(ret.date), new Date(ret.date + 12096E5)];
      ret.dName = thisDate[0].toISOString().substr(0, 10) + "_" + thisDate[1].toISOString().substr(5, 5);
      ret.dateA = thisDate[0].toLocaleDateString(undefined);
      ret.dateB = thisDate[1].toLocaleDateString(undefined);
      return ret;
    });
    files = files.sort((a, b) => a.fortnigt - b.fortnigt);
    var html = `
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>File</th>
          <th>Date from</th>
          <th>to</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>`;
    files.forEach(file => {
      html += `
        <tr>
          <td>${file.bName.endsWith(".log") ? file.bName : "active log"}</td>
          <td>${file.dateA}</td>
          <td>${file.dateB}</td>
          <td>
            <button class="btn btn-primary" task="download" date="${file.date}" dName="${file.dName}">Download</button>`;
      if (file.bName.endsWith(".log")) html += `
            <button class="btn btn-default" task="delete" bName="${file.bName}">Delete</button>`;
      html += `
          </td>
        </tr>`;
    });
    html += `
      </tbody>
    </table>
    <table>
      <tr>
        <td>file format:</td>
        <td><select id="fileFormat">
          <option>csv</option>
          <option>text</option>
        </select></td>
      </tr>
      <tr>
        <td>csv time format:</td>
        <td><select id="timeFormat">
          <option>JavaScript (msec since 1970)</option>
          <option>UNIX (sec since 1970)</option>
          <option>Office (days since 1900)</option>
        </select></td>
      </tr>
    </table>`;
    domTable.innerHTML = html;
    Util.hideModal();
    var buttons = domTable.querySelectorAll("button");
    for (var i = 0; i < buttons.length; i++) {
      buttons[i].addEventListener("click", event => {
        var button = event.currentTarget;
        var task = button.getAttribute("task");
        if (!task) return;
        if (task=="download") {
          var date = button.getAttribute("date");
          var dName = button.getAttribute("dName");
          if (!date || !dName) return;
          readLog(date, logData => saveFile(logData, dName));
        } else if (task=="delete") {
          var bName = button.getAttribute("bName");
          if (!bName) return;
          Util.showModal("Deleting...");
          Util.eraseStorage(bName, () => {
            Util.hideModal();
            getTrackList();
          });
        }
      });
    }
  });
}

function onInit() {
  getFnList();
}
    </script>
  </body>
</html>
