// Clock by Giles Booth for BangleJS2 using Buro Destruct Console Remix font
// based on code in https://www.espruino.com/Bangle.js+Clock+Font

Graphics.prototype.setFontBDConsoleRemix = function() {
  // Actual height 79 (84 - 6)
  var widths = atob("FhsuKzEuMzEuKy4uFg==");
  var font = atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAH8AAAAAAAAAAAAAAP+AAAAAAAAAAAAAAf/AAAAAAAAAAAAAAf/AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAA//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPwAAAAAAAAAAAAAB/wAAAAAAAAAAAAAP/wAAAAAAAAAAAAB//wAAAAAAAAAAAAP//wAAAAAAAAAAAB///AAAAAAAAAAAAP//4AAAAAAAAAAAB///AAAAAAAAAAAAP//4AAAAAAAAAAAD///AAAAAAAAAAAAf//4AAAAAAAAAAAD///AAAAAAAAAAAAf//wAAAAAAAAAAAD//+AAAAAAAAAAAAf//wAAAAAAAAAAAD//+AAAAAAAAAAAAf//wAAAAAAAAAAAH//+AAAAAAAAAAAA///wAAAAAAAAAAAH//+AAAAAAAAAAAA///gAAAAAAAAAAAA//8AAAAAAAAAAAAA//gAAAAAAAAAAAAA/8AAAAAAAAAAAAAA/gAAAAAAAAAAAAAA8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH+AAAAAAAAAAAH////AAAAAAAAAAAf////AAAAAAAAAAAf////AAAAAAAAAAA/////AAAAAAAAAAB/////AAAAAAAAAAB/////////AAAAAAB///8/////AAAAAAB///g/////AAAAAAB///A/////AAAAAAB//+A/////AAAAAAB//+A/////AAAAAAB//8A/////AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//8AAB///AAAAAAB//+AAB///AAAAAAB//+AAD///AAAAAAB///AAD///AAAAAAB///gAH///AAAAAAB///4Af///AAAAAAB/////////AAAAAAB/////////AAAAAAA/////////AAAAAAAf///////+AAAAAAAf///////8AAAAAAAH///////4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf8AAAAAAAAAAAAAB//AAAAAAAAAAAAAD//gAAAAAAAAAAAAH//4AAAAAAAAAAAAP//4AAAAAAAAAAAAf//8AAAAAAAAAAAA///+AAAAAAAAAAAA///+AAAAAAAAAAAA////AAAAAAAAAAAB////AAAAAAAAAAAB////AAAAAAAAAAAB////H////8AAAAAB////H/////AAAAAB////H/////wAAAAB////H/////4AAAAB////H/////8AAAAB////H/////+AAAAB////H/////+AAAAB////H//////AAAAB////H//////AAAAB////H//////AAAAB////H//////AAAAB////H//////gAAAB////H//////gAAAB////H//////gAAAB////H//////gAAAB////H//////gAAAA////H//////AAAAA////H//////AAAAAf///n//////AAAAAH/////////+AAAAAA/////////8AAAAAAAD///////8AAAAAAAD///////4AAAAAAAD///////wAAAAAAAD///////AAAAAAAAD//////4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/AAAP//wAAAAAAAH/wAA///4AAAAAAAP/4AB///+AAAAAAAf/8AB///+AAAAAAA//+AD////AAAAAAA//+AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAB///AD////AAAAAAA///AD////AAAAAAA///AD////AAAAAAAf//AD////AAAAAAAH//AD////AAAAAAAA//AD////AAAAAAAAA/AD/+A/AAAAAAAAA/AD/8A/AAAAAAAAA/AD/4A/AAAAAAAAA/AD/wA/AAAAAAAAA/AH/wA/AAAAAAAAA/AH/wA/AAAAAAAAA/gH/wA/AAAAAAAAA/gP/wA/AAAAAAAAA/4f/wA/AAAAAAAAA////wA/AAAAAAAAA////wA/AAAAAAAAA////gA/AAAAAAAAA////gA/AAAAAAAAA////AA/AAAAAAAAA///+AA/AAAAAAAAA///4AA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/AB+AB/gAAAAAAAH/wB+AD/4AAAAAAAP/4B+AH/8AAAAAAAf/8B+AP/+AAAAAAA//8B+Af/+AAAAAAA//+B+Af//AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B+B///AAAAAAB//+B/D///AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAB///B/////AAAAAAB///B/////AAAAAAB///D/////AAAAAAB/////////AAAAAAB/////////AAAAAAB/////////AAAAAAA////////+AAAAAAAf///////+AAAAAAAP///////8AAAAAAAH///////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH////8AAAAAAAAAAf////+AAAAAAAAAAf/////AAAAAAAAAA//////gAAAAAAAAA//////gAAAAAAAAB//////wAAAAAAAAB//////wAAAAAAAAB//////wAAAAAAAAB//////wAAAAAAAAA//////wAAAAAAAAA//////wAAAAAAAAAf/////wAAAAAAAAAP/////wAAAAAAAAAAAAB//wAAAAAAAAAAAAB//wAAAAAAAAAAAAB//wAAAAAAAAAAAAB//wAAAAAAAAAAAAB//wAAAAAAAAAAAAB//wAAAAAAAAAAAAB/////8AAAAAAAAAB//////AAAAAAAAAB//////wAAAAAAAAB//////4AAAAAAAAB//////8AAAAAAAAB//////+AAAAAAAAB//////+AAAAAAAAB//x////AAAAAAAAB//x////AAAAAAAAB//x////AAAAAAAAB//x////AAAAAAAAB//x////gAAAAAAAB//x////gAAAAAAAB//x////gAAAAAAAB//x////gAAAAAAAB//x////gAAAAAAAB//x////AAAAAAAAB//x////AAAAAAAAB//x////AAAAB//////x///+AAAAB//////x///8AAAAB//////h///8AAAAB//////h///4AAAAB//////B///gAAAAB/////+B///AAAAAB/////4B//4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAH///gAB/wAAAAAAAf///wAD/4AAAAAAAf///4AH/8AAAAAAA////8AP/+AAAAAAB////8Af/+AAAAAAB////+Af//AAAAAAB////+Af//AAAAAAB///D+Af//AAAAAAB///B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+A///AAAAAAB//+B+A///AAAAAAB//+B/B///AAAAAAB//+B/3///AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAB//+B/////AAAAAAA//+B/////AAAAAAA//8B/////AAAAAAAf/8B/////AAAAAAAP/4B/////AAAAAAAH/gB/////AAAAAAAB/AB/////AAAAAAAAAAB/////AAAAAAAAAAB/////AAAAAAAAAAA////+AAAAAAAAAAA////8AAAAAAAAAAAP///4AAAAAAAAAAAH///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB////////wAAAAAAB////////8AAAAAAB////////+AAAAAAB////////+AAAAAAB/////////AAAAAAB/////////AAAAAAA/////////AAAAAAAAAD//8f//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4P//AAAAAAAAAD//4f//AAAAAAAAAD//+///AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAD//////AAAAAAAAAB//////AAAAAAAAAB/////+AAAAAAAAAA/////8AAAAAAAAAAP////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAAAAAAAAAAAAH/gAAAAAAAAAAAAAf/wAAAAAAAAAAAAAf/4AAAAAAAAAAAAA//8AAAAAAAAAAAAA//8AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AAAAAAAAAAAAB//+AB4AAAAAAAAAB//+AH+AAAAAAAAAB//+AP/AAAAAAAAAB//+Af/gAAAAAAAAB//+Af/gAAAAAAAAB//+Af/gAAAAAAAAB//+Af/gAAAAAAAAB//+Af/gAAAAAAAAB//+Af/gAAAAAAAAB//+Af/gAAAAAAAAB//+Af/gAAAAAAAAB/////////AAAAAAB/////////AAAAAAA/////////AAAAAAA/////////AAAAAAAf////////AAAAAAAP////////AAAAAAAD////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB////wAAAAAAAAAAB////4AAAAAAAAAAB////+AAAAAAAAAAB////+AAAAAAAAAAB/////AAAAAAAA//B/////AAAAAAAH////////AAAAAAAf////h///AAAAAAA/////A///AAAAAAA////+A///AAAAAAB////+Af//AAAAAAB////+Af//AAAAAAB////+Af//AAAAAAB///D+Af//AAAAAAB///B+Af//AAAAAAB///B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB//+B+Af//AAAAAAB///B+A///AAAAAAB///B/A///AAAAAAB///D/h///AAAAAAB/////////AAAAAAB/////////AAAAAAA/////////AAAAAAA////////+AAAAAAAf///////8AAAAAAAP///////4AAAAAAAD///////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH////4AAAAAAAAAAP////8AAAAAAAAAAf/////AAAAAAAAAA//////AAAAAAAAAB//////gAAAAAAAAB//////gAAAAAAAAB//////gAAAAAAAAB//////gAAAAAAAAB//////gAAAAAAAAB//////gAAAAAAAAB//////gAAAAAAAAB///3//gAAAAAAAAB///B//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB//+A//gAAAAAAAAB///A//gAAAAAAAAB///j//gAAAAAAAAB/////////AAAAAAB/////////AAAAAAB/////////AAAAAAA/////////AAAAAAAf////////AAAAAAAP////////AAAAAAAH////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAACAAAAAAAAAAAB+AAfwAAAAAAAAAAH/gA/4AAAAAAAAAAH/gB/8AAAAAAAAAAP/wB/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAP/wD/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA");
  var scale = 1; // size multiplier for this font
  g.setFontCustom(font, 46, widths, 96+(scale<<8)+(1<<16));
};

// timeout used to update every minute
var drawTimeout;

// schedule a draw for the next minute
function queueDraw() {
  if (drawTimeout) clearTimeout(drawTimeout);
  drawTimeout = setTimeout(function() {
    drawTimeout = undefined;
    draw();
  }, 60000 - (Date.now() % 60000));
}


function draw() {
  g.reset();  
  // work out locale-friendly date/time
  var date = new Date();
  var timeStr = require("locale").time(date,1);
  var hh = timeStr.substr(0,2);
  // Kludge to add leading zeros to hours - if recoding please implement leading zeros:
  // Leading zeroes are an integral part of the design.
  // If the hour is single digit the first character of the string will be 
  // space, in which case a zero is added. As there is no space in the font, 
  // spaces are ignored.
  if (hh.substr(0,1) == ' ') {
    hh = '0' + hh;
  }
  var mm = timeStr.substr(-3);
  var longDateStr = require("locale").dow(new Date(), 1) + ' ' + date.getDate() + ' ' + require("locale").month(new Date(), 1) + ' ' + date.getFullYear();
  // draw time
  g.setFont("BDConsoleRemix");
  g.clearRect(0,28,175,175); // clear the background
  g.drawString(hh,0,16);
  g.drawString(mm,58,90);
  // draw date
  g.setFont("6x8");
  g.drawString(longDateStr,0,168);
  // queue draw in one minute
  queueDraw();
}

// Clear the screen once, at startup
g.clear();
// draw immediately at first, queue update
draw();
// Stop updates when LCD is off, restart when on
Bangle.on('lcdPower',on=>{
  if (on) {
    draw(); // draw immediately, queue redraw
  } else { // stop draw timer
    if (drawTimeout) clearTimeout(drawTimeout);
    drawTimeout = undefined;
  }
});
// Show launcher when middle button pressed
Bangle.setUI("clock");
// Load widgets
Bangle.loadWidgets();
Bangle.drawWidgets();